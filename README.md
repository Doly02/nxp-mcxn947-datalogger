## Digital Data Logger with Information Loss Prevention in Case of Power Failure

- Author: Tomáš Dolák 
- Login: [xdolak09](https://www.vut.cz/lide/tomas-dolak-247220)
- Email: <xdolak09@stud.fit.vutbr.cz>
- Supervisor: Ing. Václav Šímek
- Consultant: Ing. Martin Moštěk PhD.

The goal of this project is to develop a digital data logger that captures serial data from a UART peripheral, timestamps it, and stores the logged data on an SD card.
A key requirement of the implementation is to ensure data integrity by preventing loss in the event of a power failure. This digital data logger was developed based on the requirements provided by the Wireless Charging Team at NXP Semiconductors.


### Table of Contents
- [Requirements](#requirements)
    - [Hardware Components](#hardware-components)
    - [Software Requirements](#software-requirements)
- [Repository Organization](#repository-organization)
- [How to Use the Digital Data Logger](#how-to-use-the-digital-data-logger)
    - [Signal Diodes](#signal-diodes)
    - [Data Recording](#data-recording)
    - [Reading Data from the Data Logger](#reading-data-from-the-data-logger)
    - [Structure of Logged Data](#structure-of-logged-data)
    - [Format of Logged Entries](#format-of-logged-entries)
- [Developer Notes](#developer-notes)
    - [Modules](#modules)
- [Testing](#testing)
    - [Functional Testing](#functional-testing)
    - [Static Code Analysis](#static-code-analysis)
- [Known Issues](#known-issues)
- [References](#references)

### Requirements 
To build and run `datalogger`, you will need the following:

#### Hardware Components
1. NXP FRDM-MCXN947 Development Board
2. Expansion Shield Proposed in This Bachelor Thesis

#### Software Requirements
1. MCUXpresso IDE v11.10.0 With GCC-based ARM Embedded Toolchain (Arm-none-eabi-gcc Compiler)
1. NXP SDK FRDM-MCXN947 Version 2.16.000

### Repository Organization
```
/nxp-mcxn947-datalogger
├── application/                 # Main Directory With Digital Recorder Firmware.
│   ├── source/                  # Contains The Firmware Source Files.
│   ├── doc/                     # HTML and LaTeX Firmware Documentation Generated by Doxygen.
│   ├── include/                 # Contains The Firmware Header Files.
│   └── others...                # Project Files (.cproject & .project), Libraries (e.g. FATFS), FreeRTOS, Utilities, Modules and Drivers From NXP SDK.
│
├── hardware/
│   ├── components/              # List of Used Hardware Components on Expansion Shield.
│   ├── design/                  # KiCAD Project Containing Schematic and PCB Design.
│   └── pinout_datalogger.xlsx   # Table With Overview of Microcontroller Pin Connections.
├── power_consumption/           # Digital Data Logger Power Consumption Data, Measured By Power Profiler Kit II. [1]
├── tests/
│   ├── functional_tests/        # Functional Test Folder For Verifying Correct Data Collection.
│   │   ├── test_files/          # Test Files Used By serial_tests.py Script.
│   │   ├── stress_test.py       # Script With Stress Test For Digital Data Logger Sends Data Continiously With Baudrate 921600.
│   │   └── serial_tests.py      # serial_tests.py Script.
│   └── static_analysis/
│       ├── outputs/             # Contains Outputs of Static Code Analysis According To MISRA C:2012 Rules, Performed by PC-lint Tool.
│       ├── parsers/             # Contains Parsers That Filter Rule-Breakings MISRA Rules From The Required and Mandatory Categories.
│       ├── lint_config.lnt      # Configuration File of PC Lint Plus.
│       └── sources.lst          # Defines a Set of Files To Be Analyzed by PC Lint Plus.
├── thesis/
│   ├── project.tex                             # Main LaTeX Project of Technical Report.
│   ├── project-01-kapitoly-chapters.tex        # Chapters LaTeX Project of Technical Report.
│   ├── project-20-literatura-bibliography.bib  # Bibliography of Technical Report.
│   ├── project-30-prilohy-appendices.tex       # Appendices of Technical Report.
│   ├── table-of-extraneous-words.tex           # Table of Extraneous Words in Technical Report.
│   ├── bib-styles
│   ├── obrazky-figures/         # Used Figures.
│   ├── template-fig/            # VUT Logo.
│   └── diagrams/                # Created Digrams For Technical Report.
│
├── config/                     # Contains a Sample Configuration File That Can Be Used To Configure The Behaviour of The Digital Recorder.
├── README.md
```

### How to Use the Digital Data Logger

#### Signal Diodes

The digital data logger is equipped with five status LEDs (labeled 1–5) located on the front side of the enclosure. These LEDs visually indicate the current operational state of the logger.

The image below shows the placement and labeling of each LED on the front panel of the enclosure:

<p align="center">
  <img src="misc/signal-diodes-datalogger.jpg" alt="Data logger status LEDs" width="580"/><br>
  <em>Data logger status LEDs </em><br>
</p>

The table below describes the function of each LED:

| LED | Description |
|-----|-------------|
| 1   | Lights up when the available free space on the SD card falls below the limit defined by the `free_space` parameter in the configuration file. |
| 2   | Indicates an error condition. This LED turns on if the configuration file is invalid or if a critical error occurs during data recording (e.g., file creation failure or UART framing error). |
| 3   | Signals that the data logger is no longer actively recording. This state occurs, for example, when the monitored device stops transmitting data or is disconnected. |
| 4   | Blinks during active data recording to indicate that data is being received and saved to the SD card. |
| 5   | Lights up approximately 16 seconds after powering the logger to indicate that the backup capacitor is sufficiently charged. Once lit, it is safe to disconnect the device from power without risking data loss. |

#### Data Recording
1. **(Optional But Recommended)** Prepare the configuration file `config`, which should be placed in the root directory of the SD card.  
This file allows you to customize the data logger's behavior instead of using the default configuration.

<p align="center">
  <img src="misc/config-file.jpg" alt="Location of the config file on the SD card" width="480"/><br>
  <em>Location of the config file on the SD card</em><br>
</p>



Example content of `config`:
```
baudrate=115200
file_size=2048
stop_bits=1
data_bits=8
parity=none
free_space=50
```
- **Note:** The order of parameters is not fixed.

If some of the parameters in the configuration file are missing or the configuration file is missing completely,  
the default values defined in the `defs.h` file are used.

| Parameter      | Default Value                 | Data Type                      |
|----------------|-------------------------------|--------------------------------|
| `baudrate`     | `230400`                      | uint32_t                       |
| `file_size`    | `8192`                        | uint32_t (in KiB)              |
| `stop_bits`    | `kLPUART_OneStopBit`          | enum (lpuart_stop_bit_count_t) |
| `data_bits`    | `kLPUART_EightDataBits`       | enum (lpuart_data_bits_t)      |
| `parity`       | `kLPUART_ParityDisabled`      | enum (lpuart_parity_mode_t)    |
| `free_space`   | `50`                          | uint32_t (in MiB)              |


2. Insert the SD card (type SDHC) into the data logger.

3. Power on the data logger via USB or another power source. The data logger will automatically:
- Load the configuration from `config` (if present)
- After startup, the data logger enters the recording mode by default. At the beginning of the record task, it initializes the SD card, and if a new or unformatted card is detected,  
  the firmware will automatically format it and initialize the FAT file system with 32-bit LBA.

4. Wait until the LED 5 indicator turns on.  
   This LED indicates that the digital data logger can be safely disconnected without the risk of data loss or file system corruption.

5. Connect the digital data logger to the monitored device that transmits serial data via UART.  
   Once the data transmission starts, the data logger will indicate active reception by blinking a dedicated LED 4,  
   which is shown in the following image.

6. At this point, the digital data logger is actively recording incoming UART data.  
   During recording, the same LED continuously blinks to indicate that data logging is in progress.

7. If an error occurs during UART data reception (e.g. framing error),  
   the digital data logger will illuminate a separate error LED 2  
   to indicate that logging has been interrupted due to a fault.

   If the error prevents further data reception, an additional LED 3 will also light up  
   to signal that the device can no longer continue logging until it is restarted or the error is resolved.

8. To safely stop data logging, disconnect the digital data logger from the monitored device.  
   At this point, all buffered data will be properly finalized and stored on the SD card.  
   The status LED D3 will then light up to indicate that data reception has been halted  
   and the device is in standby mode.

9. To resume data logging after it has been halted, simply reconnect the digital data logger  
   to the monitored UART device. The logger will automatically return to recording mode  
   (described in step 6) and continue capturing incoming data.

10. In the event of a power disconnection during logging,  
    the digital data logger detects the power loss and automatically saves all buffered data.  
    The recording is then gracefully finalized to prevent data loss or file system corruption.


#### Reading Data from the Data Logger
To read the recorded data from the digital data logger, simply connect the device to a computer using the USB1_HS connector.  
The data logger will automatically switch into data access mode (MSC mode), and the SD card will be exposed as a standard mass storage device,  
allowing the user to copy the recorded data files.

<p align="center">
  <img src="misc/session-directories.jpg" alt="Organization of session directories with logs on SD cards" width="480"/><br>
  <em>Organization of session directories with logs on SD cards</em><br>
</p>

#### Structure of Logged Data
After each startup, the data logger creates a new session directory in which all the logs from the current runtime are stored.  
These session folders are organized by the date and an incrementing counter in the format:

```
YYYYMMDD_X/
```

Where:  
- `YYYYMMDD` is the date of the session creation  
- `X` is an integer session index used to differentiate multiple sessions created on the same day

After data has been recorded, each session folder contains text-based log files storing the data collected during the corresponding session.  
The maximum size of each log file is determined by the `file_size` parameter defined in the configuration file (see chapter on configuration).  
Log files are named using the following format:

```
YYYYMMDD_HHMMSS_X.txt
```

- `YYYYMMDD_HHMMSS` is the timestamp when the log file was created  
- `X` is an index used to differentiate multiple files created at the same second

#### Format of Logged Entries
Each logged line represents a single data record terminated by a line break sequence (`\r\n`).  
Every line is prefixed with a timestamp in the format:

```
(HH:MM:SS) Logged Message
```

This timestamp represents the time when the specific data was captured by the logger.  
The following example illustrates the typical appearance of consecutive logged lines in a file:


```
(00:10:16) New Data 23741
(00:10:16) New Data 23742
(00:10:16) New Data 23743
(00:10:16) New Data 23744
(00:10:16) New Data 23745
(00:10:16) New Data 23746
(00:10:16) New Data 23747
(00:10:16) New Data 23748
(00:10:16) New Data 23749
```

### Developer Notes
All application-level source and header files are located in the `source/` and `include/` directories.

The firmware is structured into several functional modules, such as recording logic, mass storage access, power loss detection, and system status signaling.  
Many of these modules can be individually enabled or disabled as needed. This behavior is achieved through conditional compilation in ISO C, and logic blocks are active only  
if enabled via preprocessor macros. These settings are centrally managed in the application configuration header file `defs.h`.

The `defs.h` configuration file also includes the option to control the verbosity of firmware output messages. The firmware supports three message output levels:

- **Error Messages** (prefixed with `ERR:`) report critical conditions. This level is always active and can't be disabled.

```
PRINTF("ERR: Failed to Create File %s. Error=%d\r\n", u8FileName, (uint32_t)status);
```

- **Informational Messages** (prefixed with `INFO:`) provide context such as initialization progress, configuration file loading, creation of log, etc.

```
PRINTF("INFO: Created Log %s.\r\n", u8FileName);
```

- **Debug messages** (prefixed with `DEBUG:`) offer the most detailed output and include additional technical details useful during development.

```
PRINTF("DEBUG: File System Not Found. Creating FAT File System...\r\n");
```

All of these outputs are provided through the UART serial interface. The firmware uses the `LP_FLEXCOMM4` UART peripheral instance,  
configured with the following parameters:

| Parameter      | Value    | 
|----------------|----------|
| Baudrate       | 115200   |
| Data Bits      | 8        |
| Stop Bit       | 1        |
| Parity         | None     |

The firmware runs on the FreeRTOS real-time operating system. To ensure maximum reliability and predictability, only static memory  
allocation is used throughout the firmware. All tasks and synchronization primitives are created with predefined memory sizes,  
and dynamic memory allocation is fully disabled in the FreeRTOS configuration. Additionally, specific memory allocation functions  
for system tasks such as the idle task and timer task have been implemented to support fully static operation.

The overall hardware and software initialization procedures are handled by the `APP_InitBoard()` function, declared in the header file _app_initialization.h_  
and defined in the source file _app_initialization.c_.

The application consists of two FreeRTOS tasks – _record_task_, which is responsible for recording UART data, and _msc_task_, responsible for exposing the recorded data  
via USB. These tasks are implemented in `app_tasks.c` and `pp_tasks.h`, and are created and started from within the `main.c` file.

### Modules
The application files (`main.c`, `app_tasks.c`, and `app_initialization.c`) utilize the following separate modules.  
Each module has its own source and header file:

- `error` – Handles errors and defines error codes.  
- `led` – Manages LED Indicators For System Status.
- `mass_storage` – Provides access to log files over USB MSC.  
- `parser` – Parses the configuration file (`config`) from the SD card.
- `pwrloss_det` – Detects and reacts to power loss.
- `record` – Implements logic for recording incoming serial data from UART.
- `task_switching` – Includes the method for detection of attached or detached application USB.
- `time` – Provides date/time handling for file naming and timestamping (external and internal RTCs).
- `uart` – Includes initialization (+ configuration), enabling and disabling of the UART peripheral.  
- `temperature` – Extension for temperature measurement using the P3T1755 on-board temperature sensor on the FRDM-MCXN947.

### Testing

#### Functional Testing
The digital data logger was tested using a Python script located in the `tests/` directory under the name `serial_test.py`.

The script `serial_test.py` simulates the monitored device by reading test text files and sending their contents as serial data through the COM port to the digital data logger.  
There is a time delay between each file being sent, which deliberately causes the `CONSOLELOG_Flush()` function to be called,  
so that each test input is recorded in a separate file that can be compared against the original test file.

Scripted testing was performed at various baud rates, with testing primarily focused on baud rates corresponding to actual deployment scenarios.  
After the test was completed, the recorded outputs were compared to the original test files. The results of the comparison confirmed that in all cases tested,  
the transfer was correct and there was no data loss or corruption.

The digital data logger was also successfully verified using the `stress_test.py` script that contains a stress test.  
In this test, data was sent at 921600 baud. The data was first collected into a circular buffer of 4 KiB,  
from which it was then stored on the SD card in blocks of 4 KiB. The resulting recording files were 1 MiB in size.

Functional testing also covered the behavior of the digital recorder in non-standard scenarios that may occur during real-world deployment.The Results are Summarized in Table Below.

| Test description                                                      | Expected result                                                                                   | Passed |
|-----------------------------------------------------------------------|---------------------------------------------------------------------------------------------------|--------|
| Missing configuration file                                            | Error indication using LED D2, recording interrupted                                              | Yes    |
| Missing `baudrate` value in configuration                             | Start recording with default `baudrate` value                                                     | Yes    |
| Recording on a new unformatted SD card                                | SD card is formatted, file system initialized, and device then records incoming data              | Yes    |
| Recording with file size of 512 B                                     | File created and properly closed upon reaching limit                                              | Yes    |
| Recording with file size of 1 MB                                      | File created and properly closed upon reaching limit                                              | Yes    |
| Low free SD card capacity (i.e., below value of parameter `free_space`) | Indication via LED                                                                                | Yes    |
| Transfer of recorded data from the digital recorder                   | Records transferred to host device from the digital recorder                                      | Yes    |


#### Static Code Analysis
In addition to functional testing, static analysis of the source code was performed using rules from the MISRA (_Motor Industry Software Reliability Association_) specification, specifically MISRA C:2012. The focus was primarily on rules classified as required and mandatory. All detected violations in these categories were either corrected or justified through comments in the source code, including a reference to the relevant rule and a rationale for the exception.

The code analysis was performed with tool PC-lint Plus v2.2 developed by Vector. [2]


### Known Issues
No issues were observed during development, testing, or practical usage of the digital data logger.

#### References
[1] "Nordic Semiconductors Power Profiler Kit II" [online]. [cited 2025-5-6]. Available at [https://www.nordicsemi.com/Products/Development-hardware/Power-Profiler-Kit-2](https://www.nordicsemi.com/Products/Development-hardware/Power-Profiler-Kit-2)

[2] "PC-lint Plus 2.2 Static Code Analysis Tool for C and C++ Source Code" [online]. [cited 2025-5-6]. Available at [https://pclintplus.com/](https://pclintplus.com/)