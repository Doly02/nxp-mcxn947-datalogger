## Digital Data Logger with Information Loss Prevention in Case of Power Failure

- Author: Tomáš Dolák 
- Login: [xdolak09](https://www.vut.cz/lide/tomas-dolak-247220)
- Email: <xdolak09@stud.fit.vutbr.cz>
- Supervisor: Ing. Výclav Šímek
- Consultant: Ing. Martin Moštěk PhD.

The Goal of This Project Is To Developt Data Logger That Will Record Datalogs From UART Peripheral And Store Them 
on The SD Card, And With Prevention of Data Loss in Case of Power Failure.   

### Table of Contents
- [Requirements](#requirements)
    - [Hardware Components](#hardware-components)
    - [Software Requirements](#software-requirements)
- [Repository Organization](#repository-organization)
- [How to Use the Digital Data Logger](#how-to-use-the-digital-data-logger)
    - [Data Recording](#data-recording)
    - [Reading Data from the Datalogger](#reading-data-from-the-datalogger)
    - [Structure of Logged Data](#structure-of-logged-data)
- [Known Issues](#known-issues)

### Requirements 
To build and run `datalogger`, you will need the following:

#### Hardware Components
1. NXP FRDM-MCXN947 Development Board
2. Expansion Shield Proposed In This Bachelor Thesis

#### Software Requirements
1. MCUXpresso IDE v11.10.0 With GCC-based ARM Embedded Toolchain (Arm-none-eabi-gcc Compiler)


### Repository Organization
```
/nxp-mcxn947-datalogger
├── application/
├── hardware/
│   ├── components/             # List of Used Hardware Components on Expansion Shield
│   ├── design/                 # KiCAD Project Containing Schematic and PCB Design
│   └── pinout_datalogger.xlsx  # Table With Overview of Microcontroller Pin Connections.
├── power_consumption/          # Digital Data Logger Power Consumption Data, Measured By Power Profiler Kit II
├── tests/
│   ├── functional_tests/       # Functional Test Folder For Verifying Correct Data Collection
│   │   ├── test_files/         # Test Files Used By serial_tests.py Script
│   │   ├── README.md
│   │   └── serial_tests.py     # serial_tests.py Script
│   └── static_analysis/
│       ├── outputs/            # Contains Outputs of Static Code Analysis According To MISRA C:2012 Rules, Performed by PC-lint Tool
│       ├── parsers/            # Contains Parsers That Filter Rule-Breakings MISRA Rules From The Required and Mandatory Categories
│       ├── lint_config.lnt     # Configuration File of PC Lint Plus
│       └── sources.lst         # Defines a Set of Files To Be Analyzed by PC Lint Plus
├── thesis/
│   ├── main_page.tex
│   ├── /pics
│   └── make/
├── application/                # Main Directory With Digital Recorder Firmware
│   ├── source/                 # Contains The Firmware Source Files
│   ├── doc/                    # HTML and LaTeX Firmware Documentation Generated by Doxygen
│   └── include/                # Contains The Firmware Header Files
│
├── config/                     # Contains a Sample Configuration File That Can Be Used To Configure The Behaviour of The Digital Recorder
├── README.md
```

### How to Use the Digital Data Logger

#### Data Recording
1. (Optional But Recommended) Prepare The Configuration File `config.txt`, Which Should Be Placed in The Root Directory of The SD Card. 
This File Allows You To Customize The Data Logger's Behavior Instead of Using The Default Configuration.

Example content of `config.txt`, But The Order of Parameters Is Not Fixed:
```
baudrate=115200
file_size=2048
stop_bits=1
data_bits=8
parity=none
free_space=50
```

If Some of The Parameters in The Configuration File Are Missing or The Configuration File is Missing Completely, 
The Default Values Defined In The defs.h File Are Used

| Parameter      | Default Value                 | Data Type                      |
|----------------|-------------------------------|--------------------------------|
| `baudrate`     | `230400`                      | unsigned long                  |
| `file_size`    | `8192`                        | int (in KB)                    |
| `stop_bits`    | `kLPUART_OneStopBit`          | enum (lpuart_stop_bit_count_t) |
| `data_bits`    | `kLPUART_EightDataBits`       | enum (lpuart_data_bits_t)      |
| `parity`       | `kLPUART_ParityDisabled`      | enum (lpuart_parity_mode_t)    |
| `free_space`   | `50`                          | unsigned long (in MB)          |


2. Insert The SD Card (Type SDHC) Into The Data Logger 

3. Power On The Data Logger Via USB or Another Power Source. The Data Logger Will Automatically:

-   Load The Configuration From Config.txt (If Present)
-   After Startup, The Data Logger Enters The Recording Mode By Default. At The Beginning of Record Task, It Initializes The SD Card and If a New or Unformatted Card Is Detected, 
    The Firmware Will Automatically Formatted and The FAT File System With 32-bit LBA is Initialized.

4.  Wait Until The LED Indicator (Shown in The Following Image) Turns On.  
    This LED Indicates That The Digital Data Logger Can Be Safely Disconnected Without The Risk of Data Loss Or File System Corruption.

5. Connect The Digital Data Logger to The Monitored Device That Transmits Serial Data via UART.  
   Once The Data Transmission Starts, The Data Logger Will Indicate Active Reception by Blinking a Dedicated LED,  
   Which Is Shown in The Following Image.

6. At This Point, The Digital Data Logger Is Actively Recording Incoming UART Data.  
   During Recording, The Same LED Continuously Blinks To Indicate That Data Logging Is in Progress.

7. If an Error Occurs During UART Data Reception (e.g., Framing Error),  
   The Digital Data Logger Will Illuminate a Separate Error LED (Shown in the Following Image)  
   to Indicate That Logging Has Been Interrupted Due to a Fault.

   If the Error Prevents Further Data Reception, an Additional LED (D3) Will Also Light Up  
   to Signal That The Device Can No Longer Continue Logging Until It Is Restarted or the Error is Resolved.

8. To Safely Stop Data Logging, Disconnect The Digital Data Logger From The Monitored Device.  
   At This Point, All Buffered Data Will Be Properly Finalized and Stored on The SD Card.  
   The Status LED D3 Will Then Light Up To Indicate That Data Reception Has Been Halted  
   And The Device Is in Standby Mode.

9. To Resume Data Logging After It Has Been Halted, Simply Reconnect The Digital Data Logger  
   to The Monitored UART Device. The Logger Will Automatically Return to Recording Mode  
   (Described in Step 6) and Continue Capturing Incoming Data.

10. In The Event of a Power Disconnection During Logging,  
    The Digital Data Logger Detects The Power Loss and Automatically Saves All Buffered Data.  
    The Recording Is Then Gracefully Finalized To Prevent Data Loss or File System Corruption.

#### Reading Data from the Datalogger
To Read The Recorded Data From The Digital Data Logger, Simply Connect The Device To a Computer Using The USB_HS Connector. 
The Data Logger Will Automatically Switch Into Data Acess Mode (MSC mode), and The SD Card Will Be Exposed as a Standard Mass Storage Device, 
Allowing The User To Copy The Recorded Data Files.

#### Structure of Logged Data
After Each Startup, The Data Logger Creates a New Session Directory In Which All The Logs From The Current Runtime Are Stored. 
These Session Folders Are Organized By The Date and an Incrementing Counter In The Format:

```
YYYYMMDD_X/
```

Where:
- `YYYYMMDD` is The Date of The Session Creation
- `X` is an Integer Session Index Used To Differentiate Multiple Sessions Created on The Same Day

After Data Has Been Recorded, Each Session Folder Contains Text-Based Log Files Storing The Data Collected During The Corresponding Session. 
The Maximum Size of Each Log File is Determined by The `file_size` Parameter Defined in The Configuration File (See Chapter on Configuration). 
Log files are named using the following format:

```
YYYYMMDD_HHMMSS_X.txt
```

- `YYYYMMDD_HHMMSS` is The Timestamp When The Log File Was Created
- `X` is an Index Used To Differentiate Multiple Files Created at The Same Second


### Known Issues
No Issues Were Observed During Development, Testing, or Practical Usage of The Digital Data Logger.